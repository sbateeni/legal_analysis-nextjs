import type { NextApiRequest, NextApiResponse } from 'next';
import { GoogleGenerativeAI } from '@google/generative-ai';

// تعريف مراحل التحليل القانوني (12 مرحلة)
const STAGES = [
  'المرحلة الأولى: تحديد المشكلة القانونية',
  'المرحلة الثانية: جمع المعلومات والوثائق',
  'المرحلة الثالثة: تحليل النصوص القانونية',
  'المرحلة الرابعة: تحديد القواعد القانونية المنطبقة',
  'المرحلة الخامسة: تحليل السوابق القضائية',
  'المرحلة السادسة: تحليل الفقه القانوني',
  'المرحلة السابعة: تحليل الظروف الواقعية',
  'المرحلة الثامنة: تحديد الحلول القانونية الممكنة',
  'المرحلة التاسعة: تقييم الحلول القانونية',
  'المرحلة العاشرة: اختيار الحل الأمثل',
  'المرحلة الحادية عشرة: صياغة الحل القانوني',
  'المرحلة الثانية عشرة: تقديم التوصيات',
];

// تفاصيل كل مرحلة (يمكن نقلها لاحقًا من analysis_stages.py)
const STAGES_DETAILS: Record<string, { description: string; key_points: string[]; questions: string[] }> = {
  'المرحلة الأولى: تحديد المشكلة القانونية': {
    description: 'تحديد وتوضيح المشكلة القانونية الرئيسية والمسائل الفرعية المرتبطة بها في إطار النظام القانوني الفلسطيني',
    key_points: [
      'تحديد الأطراف المعنية في إطار القوانين الفلسطينية',
      'تحديد موضوع النزاع الرئيسي وفقاً للقوانين الفلسطينية',
      'تحديد المسائل القانونية الفرعية في النظام القانوني الفلسطيني',
      'تحديد الإطار الزمني للقضية وفقاً للقوانين الفلسطينية',
    ],
    questions: [
      'ما هي المشكلة القانونية الرئيسية في إطار القوانين الفلسطينية؟',
      'من هم الأطراف المعنيون وفقاً للقوانين الفلسطينية؟',
      'ما هي المسائل الفرعية المرتبطة بالقضية في النظام القانوني الفلسطيني؟',
      'ما هو الإطار الزمني للنزاع وفقاً للقوانين الفلسطينية؟',
    ],
  },
  'المرحلة الثانية: جمع المعلومات والوثائق': {
    description: 'جمع وتنظيم كافة المستندات والوثائق والمعلومات المتعلقة بالقضية في إطار النظام القانوني الفلسطيني',
    key_points: [
      'جمع الوثائق الرسمية الفلسطينية',
      'جمع الأدلة والمستندات الداعمة وفقاً للقوانين الفلسطينية',
      'توثيق المراسلات والاتصالات في إطار النظام القانوني الفلسطيني',
      'تنظيم وفهرسة المستندات وفقاً للمعايير القانونية الفلسطينية',
    ],
    questions: [
      'ما هي الوثائق المتوفرة في إطار القوانين الفلسطينية؟',
      'هل هناك أدلة داعمة وفقاً للقوانين الفلسطينية؟',
      'ما هي المستندات الناقصة في النظام القانوني الفلسطيني؟',
      'كيف يمكن تنظيم المعلومات بشكل فعال وفقاً للمعايير القانونية الفلسطينية؟',
    ],
  },
  'المرحلة الثالثة: تحليل النصوص القانونية': {
    description: 'تحليل النصوص القانونية والتعرف على المفاهيم الأساسية والمصطلحات المستخدمة في النصوص القانونية، مع التركيز على المفاهيم القانونية الفلسطينية',
    key_points: [
      'تحليل المفاهيم الأساسية في النصوص القانونية (مثل المفاهيم القانونية، المصطلحات، المصطلحات القانونية، المفاهيم القضائية، المفاهيم الفقهية، المفاهيم الواقعية)',
      'تحديد المصطلحات القانونية المستخدمة في النصوص القانونية وتحليل معناها في إطار النظام القانوني الفلسطيني',
      'تحليل المفاهيم القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
      'تحليل المفاهيم القضائية والفقهية والواقعية المتكررة والمتطرفة في النصوص القانونية',
    ],
    questions: [
      'ما هي المفاهيم الأساسية التي يجب أن نفهمها في النصوص القانونية؟',
      'ما هي المصطلحات القانونية التي يجب أن نفهمها في النصوص القانونية؟',
      'ما هي المفاهيم القانونية الفلسطينية التي تظهر بشكل متكرر في النصوص القانونية؟',
      'ما هي المفاهيم القضائية والفقهية والواقعية التي تظهر بشكل متطرف في النصوص القانونية؟',
    ],
  },
  'المرحلة الرابعة: تحديد القواعد القانونية المنطبقة': {
    description: 'تحديد القواعد القانونية المنطبقة والمتطلبات القانونية المطلوبة في إطار النظام القانوني الفلسطيني، مع التركيز على القواعد القانونية الفلسطينية',
    key_points: [
      'تحديد القواعد القانونية المنطبقة في إطار القوانين الفلسطينية (مثل القواعد القانونية الأساسية، القواعد القانونية التفصيلية، القواعد القانونية التنفيذية، القواعد القانونية التنظيمية)',
      'تحديد المتطلبات القانونية المطلوبة في إطار القوانين الفلسطينية (مثل المتطلبات القانونية الأساسية، المتطلبات القانونية التفصيلية، المتطلبات القانونية التنفيذية، المتطلبات القانونية التنظيمية)',
      'تحديد القواعد القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
      'تحديد المتطلبات القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
    ],
    questions: [
      'ما هي القواعد القانونية المنطبقة التي يجب أن نفهمها في النصوص القانونية؟',
      'ما هي المتطلبات القانونية المطلوبة التي يجب أن نفهمها؟',
      'ما هي القواعد القانونية الفلسطينية التي تظهر بشكل متكرر في النصوص القانونية؟',
      'ما هي المتطلبات القانونية الفلسطينية التي تظهر بشكل متطرف في النصوص القانونية؟',
    ],
  },
  'المرحلة الخامسة: تحليل السوابق القضائية': {
    description: 'تحليل السوابق القضائية والمصطلحات المستخدمة في السوابق القضائية، مع التركيز على السوابق القضائية الفلسطينية',
    key_points: [
      'تحليل المصطلحات القانونية المستخدمة في السوابق القضائية (مثل المصطلحات القضائية، المصطلحات القانونية، المصطلحات الفقهية، المصطلحات الواقعية)',
      'تحديد المصطلحات القضائية المستخدمة في السوابق القضائية وتحليل معناها في إطار النظام القانوني الفلسطيني',
      'تحليل المصطلحات القضائية الفلسطينية المتكررة والمتطرفة في السوابق القضائية',
      'تحليل المصطلحات الفقهية والواقعية المتكررة والمتطرفة في السوابق القضائية',
    ],
    questions: [
      'ما هي المصطلحات القانونية التي يجب أن نفهمها في السوابق القضائية؟',
      'ما هي المصطلحات القضائية التي يجب أن نفهمها في السوابق القضائية؟',
      'ما هي المصطلحات القضائية الفلسطينية التي تظهر بشكل متكرر في السوابق القضائية؟',
      'ما هي المصطلحات الفقهية والواقعية التي تظهر بشكل متطرف في السوابق القضائية؟',
    ],
  },
  'المرحلة السادسة: تحليل الفقه القانوني': {
    description: 'تحليل الفقه القانوني والمصطلحات المستخدمة في الفقه القانوني، مع التركيز على الفقه القانوني الفلسطيني',
    key_points: [
      'تحليل المصطلحات القانونية المستخدمة في الفقه القانوني (مثل المصطلحات القانونية، المصطلحات الفقهية، المصطلحات الواقعية)',
      'تحديد المصطلحات القانونية المستخدمة في الفقه القانوني وتحليل معناها في إطار النظام القانوني الفلسطيني',
      'تحليل المصطلحات القانونية الفلسطينية المتكررة والمتطرفة في الفقه القانوني',
      'تحليل المصطلحات الفقهية والواقعية المتكررة والمتطرفة في الفقه القانوني',
    ],
    questions: [
      'ما هي المصطلحات القانونية التي يجب أن نفهمها في الفقه القانوني؟',
      'ما هي المصطلحات الفقهية التي يجب أن نفهمها في الفقه القانوني؟',
      'ما هي المصطلحات القانونية الفلسطينية التي تظهر بشكل متكرر في الفقه القانوني؟',
      'ما هي المصطلحات الفقهية والواقعية التي تظهر بشكل متطرف في الفقه القانوني؟',
    ],
  },
  'المرحلة السابعة: تحليل الظروف الواقعية': {
    description: 'تحليل الظروف الواقعية والمصطلحات المستخدمة في الظروف الواقعية، مع التركيز على الظروف الواقعية الفلسطينية',
    key_points: [
      'تحليل المصطلحات القانونية المستخدمة في الظروف الواقعية (مثل المصطلحات القانونية، المصطلحات الواقعية)',
      'تحديد المصطلحات القانونية المستخدمة في الظروف الواقعية وتحليل معناها في إطار النظام القانوني الفلسطيني',
      'تحليل المصطلحات القانونية الفلسطينية المتكررة والمتطرفة في الظروف الواقعية',
      'تحليل المصطلحات الواقعية المتكررة والمتطرفة في الظروف الواقعية',
    ],
    questions: [
      'ما هي المصطلحات القانونية التي يجب أن نفهمها في الظروف الواقعية؟',
      'ما هي المصطلحات الواقعية التي يجب أن نفهمها في الظروف الواقعية؟',
      'ما هي المصطلحات القانونية الفلسطينية التي تظهر بشكل متكرر في الظروف الواقعية؟',
      'ما هي المصطلحات الواقعية التي تظهر بشكل متطرف في الظروف الواقعية؟',
    ],
  },
  'المرحلة الثامنة: تحديد الحلول القانونية الممكنة': {
    description: 'تحديد الحلول القانونية الممكنة والمتطلبات القانونية المطلوبة في إطار النظام القانوني الفلسطيني، مع التركيز على الحلول القانونية الفلسطينية',
    key_points: [
      'تحديد الحلول القانونية الممكنة في إطار القوانين الفلسطينية (مثل الحلول القانونية الأساسية، الحلول القانونية التفصيلية، الحلول القانونية التنفيذية، الحلول القانونية التنظيمية)',
      'تحديد المتطلبات القانونية المطلوبة في إطار القوانين الفلسطينية (مثل المتطلبات القانونية الأساسية، المتطلبات القانونية التفصيلية، المتطلبات القانونية التنفيذية، المتطلبات القانونية التنظيمية)',
      'تحديد الحلول القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
      'تحديد المتطلبات القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
    ],
    questions: [
      'ما هي الحلول القانونية الممكنة التي يجب أن نفهمها؟',
      'ما هي المتطلبات القانونية المطلوبة التي يجب أن نفهمها؟',
      'ما هي الحلول القانونية الفلسطينية التي تظهر بشكل متكرر في النصوص القانونية؟',
      'ما هي المتطلبات القانونية الفلسطينية التي تظهر بشكل متطرف في النصوص القانونية؟',
    ],
  },
  'المرحلة التاسعة: تقييم الحلول القانونية': {
    description: 'تقييم الحلول القانونية وتحديد الأولويات والأهمية في إطار النظام القانوني الفلسطيني، مع التركيز على تقييم الحلول القانونية الفلسطينية',
    key_points: [
      'تقييم الحلول القانونية في إطار القوانين الفلسطينية (مثل تقييم الحلول القانونية الأساسية، تقييم الحلول القانونية التفصيلية، تقييم الحلول القانونية التنفيذية، تقييم الحلول القانونية التنظيمية)',
      'تحديد الأولويات والأهمية في إطار القوانين الفلسطينية (مثل الأولويات القانونية الأساسية، الأولويات القانونية التفصيلية، الأولويات القانونية التنفيذية، الأولويات القانونية التنظيمية)',
      'تقييم الحلول القانونية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
      'تقييم الأولويات والأهمية الفلسطينية المتكررة والمتطرفة في النصوص القانونية',
    ],
    questions: [
      'ما هي الحلول القانونية التي يجب أن نقيمها؟',
      'ما هي الأولويات والأهمية التي يجب أن نفهمها؟',
      'ما هي الحلول القانونية الفلسطينية التي تظهر بشكل متكرر في النصوص القانونية؟',
      'ما هي الأولويات والأهمية الفلسطينية التي تظهر بشكل متطرف في النصوص القانونية؟',
    ],
  },
  'المرحلة العاشرة: اختيار الحل الأمثل': {
    description: 'اختيار الحل الأمثل والتحقق من صلاحيته في إطار النظام القانوني الفلسطيني، مع التركيز على اختيار الحل الأمثل الفلسطيني',
    key_points: [
      'اختيار الحل الأمثل في إطار القوانين الفلسطينية (مثل اختيار الحل الأمثل الأساسي، اختيار الحل الأمثل التفصيلي، اختيار الحل الأمثل التنفيذي، اختيار الحل الأمثل التنظيمي)',
      'التحقق من صلاحية الحل الأمثل في إطار القوانين الفلسطينية (مثل التحقق من صلاحية الحل الأمثل الأساسي، التحقق من صلاحية الحل الأمثل التفصيلي، التحقق من صلاحية الحل الأمثل التنفيذي، التحقق من صلاحية الحل الأمثل التنظيمي)',
      'اختيار الحل الأمثل الفلسطيني المتكرر والمتطرف في النصوص القانونية',
      'التحقق من صلاحية الحل الأمثل الفلسطيني المتكرر والمتطرف في النصوص القانونية',
    ],
    questions: [
      'ما هو الحل الأمثل الذي يجب أن نختاره؟',
      'ما هي التحقق من صلاحية الحل الأمثل التي يجب أن نفهمها؟',
      'ما هو الحل الأمثل الفلسطيني الذي تظهر بشكل متكرر في النصوص القانونية؟',
      'ما هي التحقق من صلاحية الحل الأمثل الفلسطيني التي تظهر بشكل متطرف في النصوص القانونية؟',
    ],
  },
  'المرحلة الحادية عشرة: صياغة الحل القانوني': {
    description: 'صياغة الحل القانوني وتنظيمه وتحويله إلى تنسيق قانوني في إطار النظام القانوني الفلسطيني، مع التركيز على صياغة الحل القانوني الفلسطيني',
    key_points: [
      'صياغة الحل القانوني في إطار القوانين الفلسطينية (مثل صياغة الحل القانوني الأساسي، صياغة الحل القانوني التفصيلي، صياغة الحل القانوني التنفيذي، صياغة الحل القانوني التنظيمي)',
      'تنظيم الحل القانوني في إطار القوانين الفلسطينية (مثل تنظيم الحل القانوني الأساسي، تنظيم الحل القانوني التفصيلي، تنظيم الحل القانوني التنفيذي، تنظيم الحل القانوني التنظيمي)',
      'تحويل الحل القانوني إلى تنسيق قانوني في إطار القوانين الفلسطينية (مثل تحويل الحل القانوني إلى تنسيق قانوني أساسي، تحويل الحل القانوني إلى تنسيق قانوني تفصيلي، تحويل الحل القانوني إلى تنسيق قانوني تنفيذي، تحويل الحل القانوني إلى تنسيق قانوني تنظيمي)',
      'تحويل الحل القانوني إلى تنسيق قانوني فلسطيني (مثل تحويل الحل القانوني إلى تنسيق قانوني فلسطيني أساسي، تحويل الحل القانوني إلى تنسيق قانوني فلسطيني تفصيلي، تحويل الحل القانوني إلى تنسيق قانوني فلسطيني تنفيذي، تحويل الحل القانوني إلى تنسيق قانوني فلسطيني تنظيمي)',
    ],
    questions: [
      'ما هو الحل القانوني الذي يجب أن نصيغه؟',
      'ما هي تنظيم الحل القانوني التي يجب أن نفهمها؟',
      'ما هو تحويل الحل القانوني الذي يجب أن نفهمه؟',
      'ما هو تحويل الحل القانوني الفلسطيني الذي يجب أن نفهمه؟',
    ],
  },
  'المرحلة الثانية عشرة: تقديم التوصيات': {
    description: 'تقديم التوصيات وتنظيمها وتحويلها إلى تنسيق قانوني في إطار النظام القانوني الفلسطيني، مع التركيز على تقديم التوصيات الفلسطينية',
    key_points: [
      'تقديم التوصيات في إطار القوانين الفلسطينية (مثل تقديم التوصيات الأساسية، تقديم التوصيات التفصيلية، تقديم التوصيات التنفيذية، تقديم التوصيات التنظيمية)',
      'تنظيم التوصيات في إطار القوانين الفلسطينية (مثل تنظيم التوصيات الأساسية، تنظيم التوصيات التفصيلية، تنظيم التوصيات التنفيذية، تنظيم التوصيات التنظيمية)',
      'تحويل التوصيات إلى تنسيق قانوني في إطار القوانين الفلسطينية (مثل تحويل التوصيات إلى تنسيق قانوني أساسي، تحويل التوصيات إلى تنسيق قانوني تفصيلي، تحويل التوصيات إلى تنسيق قانوني تنفيذي، تحويل التوصيات إلى تنسيق قانوني تنظيمي)',
      'تحويل التوصيات إلى تنسيق قانوني فلسطيني (مثل تحويل التوصيات إلى تنسيق قانوني فلسطيني أساسي، تحويل التوصيات إلى تنسيق قانوني فلسطيني تفصيلي، تحويل التوصيات إلى تنسيق قانوني فلسطيني تنفيذي، تحويل التوصيات إلى تنسيق قانوني فلسطيني تنظيمي)',
    ],
    questions: [
      'ما هي التوصيات التي يجب أن نقدمها؟',
      'ما هي تنظيم التوصيات التي يجب أن نفهمها؟',
      'ما هو تحويل التوصيات الذي يجب أن نفهمه؟',
      'ما هو تحويل التوصيات الفلسطيني الذي يجب أن نفهمه؟',
    ],
  },
};

// دالة توليد البرومبت لكل مرحلة (معدلة لدعم التحليل التراكمي والتحقق)
function getStagePrompt(stageName: string, text: string, previousSummaries?: string[]): string {
  const stageInfo = STAGES_DETAILS[stageName];
  let previousText = '';
  if (previousSummaries && previousSummaries.length > 0) {
    previousText = `\nملخص المراحل السابقة (يجب أن يُبنى التحليل الحالي عليها بشكل تراكمي ومتسلسل):\n${previousSummaries.map((s, i) => `- المرحلة ${i + 1}: ${s}`).join('\n')}`;
  }
  return `
${stageName}
${stageInfo?.description || ''}
${previousText}

النقاط الرئيسية للتحليل:
${stageInfo?.key_points?.map((p) => '- ' + p).join('\n')}

الأسئلة الرئيسية للإجابة:
${stageInfo?.questions?.map((q) => '- ' + q).join('\n')}

النص القانوني للتحليل:
${text}

قم بتحليل النص القانوني وفقًا لهذه المرحلة في إطار النظام القانوني الفلسطيني، مع التركيز على:
1. بناء التحليل الحالي على ملخصات المراحل السابقة بشكل تراكمي ومتسلسل.
2. الإجابة على الأسئلة الرئيسية المطروحة في إطار القوانين الفلسطينية
3. تحليل النقاط الرئيسية المحددة وفقاً للنظام القانوني الفلسطيني
4. تقديم تحليل مفصل ومدعم بالأسناد القانونية الفلسطينية
5. التحقق من صحة المعلومات القانونية بدقة وتجنب أي لغط أو أخطاء قانونية. إذا لم تكن متأكدًا من معلومة، وضّح ذلك أو اذكر مصدرها إن أمكن.
`;
}

async function callGeminiAPI(prompt: string, apiKey: string): Promise<string> {
  if (!apiKey) throw new Error('يرجى إدخال مفتاح Gemini API الخاص بك.');
  const genAI = new GoogleGenerativeAI(apiKey);
  const model = genAI.getGenerativeModel({ model: 'models/gemini-2.0-flash-001' });
  const result = await model.generateContent(prompt);
  const response = await result.response;
  return response.text();
}

// حدود الطول (تقريبي: 8000 tokens ≈ 24,000 حرف)
const MAX_CHARS = 24000;

function trimSummaries(summaries: string[]): string[] {
  let totalLength = summaries.reduce((acc, cur) => acc + (cur?.length || 0), 0);
  let trimmed = [...summaries];
  while (totalLength > MAX_CHARS && trimmed.length > 1) {
    trimmed = trimmed.slice(1);
    totalLength = trimmed.reduce((acc, cur) => acc + (cur?.length || 0), 0);
  }
  return trimmed;
}

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { text, stageIndex, apiKey, previousSummaries, finalPetition } = req.body;
  if (!text || typeof stageIndex !== 'number' || !apiKey) {
    return res.status(400).json({ error: 'Invalid input' });
  }

  // معالجة طلب العريضة النهائية
  if (finalPetition && stageIndex === -1) {
    if (!previousSummaries || !Array.isArray(previousSummaries) || previousSummaries.length === 0) {
      return res.status(400).json({ error: 'يرجى تحليل المراحل أولاً.' });
    }
    // تقطيع الملخصات إذا تجاوزت الحد
    const trimmedSummaries = trimSummaries(previousSummaries);
    // بناء برومبت خاص للعريضة النهائية
    const petitionPrompt = `
أنت خبير قانوني فلسطيني محترف. بناءً على ملخصات التحليل التالية لكل مرحلة من مراحل القضية، قم بصياغة عريضة قانونية نهائية رسمية وجاهزة للتقديم للمحكمة، بحيث تشمل جميع الجوانب القانونية والوقائعية، وتكون دقيقة وخالية من الأخطاء القانونية أو اللغط، وتستند إلى القوانين الفلسطينية ذات الصلة:

تفاصيل القضية:
${text}

ملخصات المراحل التحليلية:
${trimmedSummaries.map((s, i) => `- المرحلة ${i + 1}: ${s}`).join('\n')}

تعليمات هامة:
- ابدأ العريضة بمقدمة رسمية مناسبة.
- اعرض الوقائع بشكل موجز ودقيق.
- حلل الجوانب القانونية مستندًا إلى نتائج المراحل السابقة.
- استشهد بالنصوص القانونية الفلسطينية ذات الصلة.
- قدم طلباتك للمحكمة بشكل واضح ومهني.
- تحقق من صحة جميع المعلومات القانونية وتجنب أي لغط أو أخطاء.
- إذا لم تكن متأكدًا من معلومة، وضّح ذلك أو اذكر مصدرها إن أمكن.
- اجعل العريضة متسلسلة وواضحة وسهلة القراءة.

صياغة العريضة:
`;
    try {
      const analysis = await callGeminiAPI(petitionPrompt, apiKey);
      return res.status(200).json({ stage: 'العريضة النهائية', analysis });
    } catch (error: unknown) {
      let message = 'حدث خطأ أثناء توليد العريضة النهائية';
      if (error && typeof error === 'object' && 'message' in error) {
        message = (error as { message: string }).message;
      }
      return res.status(500).json({ error: message });
    }
  }

  // معالجة التحليل العادي لكل مرحلة
  if (stageIndex < 0 || stageIndex >= STAGES.length) {
    return res.status(400).json({ error: 'Invalid input' });
  }

  const stage = STAGES[stageIndex];
  // تقطيع الملخصات إذا تجاوزت الحد
  const trimmedSummaries = trimSummaries(previousSummaries || []);
  const prompt = getStagePrompt(stage, text, trimmedSummaries);

  try {
    const analysis = await callGeminiAPI(prompt, apiKey);
    return res.status(200).json({ stage, analysis });
  } catch (error: unknown) {
    let message = 'حدث خطأ أثناء التحليل';
    if (error && typeof error === 'object' && 'message' in error) {
      message = (error as { message: string }).message;
    }
    return res.status(500).json({ error: message });
  }
} 